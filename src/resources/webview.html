<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resizable Example</title>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <style>
    body {
      background-color: #444;
      color: #ccc;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 1px;
      color: #fff;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin: 5px 0;
    }
    .button-group button {
      padding: 5px;
      width: 90px;
      height: 30px;
      background-color: #666;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .button-group button:hover {
      background-color: #888;
    }
    .button-group button:active {
      background-color: #aaa;
    }
    .button-group p{
      position: absolute;
      left: 20%;
      font-size: 15px;
    }
    .container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      gap: 10px;
    }


    /* right editor - Figma style */ 
    .editor {
      width: 320px;
      height: 600px;
      margin: 0 auto;
      background-color: #2c2c2c;
      border-radius: 8px;
      z-index: 1;
      padding: 16px;
      box-sizing: border-box;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .editor-section {
      margin-bottom: 20px;
      background: #383838;
      border-radius: 6px;
      padding: 12px;
    }

    .editor-section-title {
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .editor-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .editor-row:last-child {
      margin-bottom: 0;
    }

    .editor-label {
      color: #b3b3b3;
      font-size: 11px;
      min-width: 60px;
      font-weight: 500;
    }

    .editor-input {
      flex: 1;
      background: #4a4a4a;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 8px;
      color: #ffffff;
      font-size: 11px;
      transition: all 0.2s ease;
    }

    .editor-input:focus {
      outline: none;
      border-color: #0066ff;
      background: #505050;
    }

    .editor-input::placeholder {
      color: #888;
    }

    .editor-color-input {
      width: 32px;
      height: 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
      background: none;
    }

    .editor-select {
      flex: 1;
      background: #4a4a4a;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 8px;
      color: #ffffff;
      font-size: 11px;
      cursor: pointer;
    }

    .editor-button {
      background: #0066ff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
      margin-top: 8px;
    }

    .editor-button:hover {
      background: #0052cc;
    }

    .editor-button.danger {
      background: #ff4757;
    }

    .editor-button.danger:hover {
      background: #ff3838;
    }

    .editor-checkbox {
      margin-right: 8px;
    }

    .selected-element-info {
      background: #4a4a4a;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 12px;
      color: #ffffff;
      font-size: 11px;
    }

    .no-selection {
      color: #888;
      font-style: italic;
      text-align: center;
      padding: 20px;
      font-size: 12px;
    }

    .specific-properties {
      display: none;
    }

    .specific-properties.visible {
      display: block;
    }


    /*layout style*/

    .lay-out-body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 85vh;
      width: 70%;
      background-color: #333;
      border: 1px solid greenyellow;
      padding: 20px;
      box-sizing: border-box;
    }
    .lay-out {
      width: 80%;
      height: 50%;
      overflow-y: auto;
      border-radius: 10px;
      padding: 10px;
      background-color: #fff;
      color: #999;
      box-sizing: border-box;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /*palette code*/
    .palette {
      width: 300px;
      max-height: 80vh; /* Allows the palette to grow but with a limit to prevent overflow */
      overflow-y: auto; /* Adds scroll if content exceeds viewport */
      background-color: #333;
      color: #666;
      border: 1px solid gold;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      box-sizing: border-box;
    }
    .item {
      padding: 1px;
      margin: 1px;
      width: 100%;
      background-color: #666;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .item:hover {
      background-color: #888;
    }
    .item:active {
      background-color: #aaa;
    }
    .item-grid {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid white;
    }
    .content {
      position: relative;
      display: none;             /* Enable flexbox */
      flex-wrap: nowrap;           /* Allow items to wrap when needed */
      flex-direction: row;
      gap: 10px; 
      padding: 1px;
      margin-top: 0px;
      margin-bottom: 5px;
      width: 100%;
      height: 60px;
      border: 1px solid gold;
      background-color: #333;
      color: #fff; 
      max-height: 50%; /* Adjust this value as needed */
      overflow-y: auto; /* Adds scroll if c */     
    }
    .content p {
      margin: 0;
      padding: 0;
    }

    .drag-item {
      width: 30%;
      background-color: #666;
      border-radius: 20px;
      border: 1px solid greenyellow;
      cursor: move; /* Changed to move cursor */
      text-align: center;
      touch-action: none;
      user-select: none;
      z-index: 10;
    }
    
    /*phone, pc or tablet*/
    #resizable-element{
        width: 100%;
        height: 100%;
        max-width: 100vw;
        max-height: 100vh;
        position: relative;
        overflow-y:auto;
        overflow-x: hidden;
    }

    /* Add styles for dropped elements */
    .dropped-element {
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 5px;
      min-width: 10%;
      min-height: 5%;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 95%;
      color: #333;
    }

    /* Enhanced resize handles for better visibility */
    .dropped-element:hover {
      border-color: #0066ff;
    }

    /* Interact.js resize handle styling */
    .interact-resizable-handle {
      position: absolute;
      background: #0066ff;
      border: 2px solid #ffffff;
      border-radius: 3px;
      width: 8px;
      height: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .dropped-element:hover .interact-resizable-handle {
      opacity: 1;
    }

    .interact-resizable-handle.top-left {
      top: -5px;
      left: -5px;
      cursor: nw-resize;
    }

    .interact-resizable-handle.top-right {
      top: -5px;
      right: -5px;
      cursor: ne-resize;
    }

    .interact-resizable-handle.bottom-left {
      bottom: -5px;
      left: -5px;
      cursor: sw-resize;
    }

    .interact-resizable-handle.bottom-right {
      bottom: -5px;
      right: -5px;
      cursor: se-resize;
    }

    .interact-resizable-handle.top {
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      cursor: n-resize;
    }

    .interact-resizable-handle.bottom {
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      cursor: s-resize;
    }

    .interact-resizable-handle.left {
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
      cursor: w-resize;
    }

    .interact-resizable-handle.right {
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
      cursor: e-resize;
    }

    /* Context menu styles */
    .context-menu {
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      width: 250px;
      border-radius: 10px;
    }

    .context-menu-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
    }

    .context-menu-item {
      margin-bottom: 10px;
      flex: 1 1 calc(25% - 10px); /* two columns */
      min-width: 120px;
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }

    .context-menu-item label {
      display: block;
      margin-bottom: 5px;
    }

    .context-menu-item input {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }

    .context-menu-button {
      margin-top: 10px;
      padding: 5px 10px;
      cursor: pointer;
      display: block;
      width: 50%;
    }

    .delete-button {
      background-color: #ff4d4d;
      color: white;
      border: none;
      margin-top: 5px;
    }

    /*check alignment*/
    .guide-line {
      position: absolute;
      background: red;
      z-index: 1000;
    }

    #v-guide {
      width: 1px;
      height: 100vh;
      display: none;
    }

    #h-guide {
      height: 1px;
      width: 100vw;
      display: none;
    }

    /* Preferences Modal Styles */
    .preferences-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preferences-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .preferences-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preferences-header h2 {
      margin: 0;
      color: #333;
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: #666;
    }

    .close-btn:hover {
      background: #f0f0f0;
      color: #333;
    }

    .preferences-body {
      padding: 20px;
    }

    .preference-group {
      margin-bottom: 16px;
    }

    .preference-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .preference-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }

    .preference-group select:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
    }

    .preferences-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .save-btn, .reset-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .save-btn {
      background: #007BFF;
      color: white;
    }

    .save-btn:hover {
      background: #0056b3;
    }

    .reset-btn {
      background: #6c757d;
      color: white;
    }

    .reset-btn:hover {
      background: #545b62;
    }

  </style>
</head>
<body>

  <h1>Device Layout Preview</h1>
  
  <!-- Button Group Above Layout -->
  <div class="button-group">
    <p>${htmlFileName}</p>
    <button onclick="resizeToPhone()" id="phone">üì± Phone</button>
    <button onclick="resizeToLaptop()" id="laptop">üíª Laptop</button>
    <button onclick="generateCode()" id="generate">Generate Code</button>
  </div>
  
  <!-- Main Layout Container -->
<div class="container">

  <!-- Figma-style Editor Panel -->
  <div id="editor" class="editor">
    <!-- Selected Element Info -->
    <div id="selection-info" class="selected-element-info">
      <div id="no-selection" class="no-selection">Select an element to edit properties</div>
      <div id="element-selected" style="display: none;">
        <strong id="selected-element-type">Element</strong>
        <div style="font-size: 10px; opacity: 0.7;" id="selected-element-id">#element-1</div>
      </div>
    </div>

    <!-- Common Properties - Always Visible -->
    <div class="editor-section">
      <div class="editor-section-title">Position & Size</div>
      
      <div class="editor-row">
        <span class="editor-label">Width</span>
        <input type="text" id="common-width" class="editor-input" placeholder="auto">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Height</span>
        <input type="text" id="common-height" class="editor-input" placeholder="auto">
      </div>
    </div>

    <div class="editor-section">
      <div class="editor-section-title">Appearance</div>
      
      <div class="editor-row">
        <span class="editor-label">Fill</span>
        <input type="color" id="common-bg-color" class="editor-color-input" value="#ffffff">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Opacity</span>
        <input type="range" id="common-opacity" class="editor-input" min="0" max="1" step="0.1" value="1">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Border</span>
        <input type="text" id="common-border-radius" class="editor-input" placeholder="0px">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Border Width</span>
        <input type="text" id="common-border-width" class="editor-input" placeholder="1px">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Border Color</span>
        <input type="color" id="common-border-color" class="editor-color-input" value="#cccccc">
      </div>
    </div>

    <!-- Effects Section -->
    <div class="editor-section">
      <div class="editor-section-title">Effects</div>
      
      <div class="editor-row">
        <span class="editor-label">Box Shadow</span>
        <input type="text" id="common-box-shadow" class="editor-input" placeholder="0 2px 4px rgba(0,0,0,0.1)">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Text Shadow</span>
        <input type="text" id="common-text-shadow" class="editor-input" placeholder="1px 1px 2px rgba(0,0,0,0.5)">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Transform</span>
        <input type="text" id="common-transform" class="editor-input" placeholder="rotate(0deg) scale(1)">
      </div>
    </div>

    <!-- Text Properties - Common for text elements -->
    <div class="editor-section">
      <div class="editor-section-title">Typography</div>
      
      <div class="editor-row">
        <span class="editor-label">Font Family</span>
        <select id="common-font-family" class="editor-select">
          <option value="">Default</option>
          <option value="Arial, sans-serif">Arial</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Times New Roman', serif">Times New Roman</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="Verdana, sans-serif">Verdana</option>
          <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
          <option value="Impact, sans-serif">Impact</option>
          <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        </select>
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Color</span>
        <input type="color" id="common-text-color" class="editor-color-input" value="#000000">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Size</span>
        <input type="text" id="common-font-size" class="editor-input" placeholder="16px">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Weight</span>
        <select id="common-font-weight" class="editor-select">
          <option value="">Default</option>
          <option value="normal">Normal</option>
          <option value="bold">Bold</option>
          <option value="lighter">Lighter</option>
          <option value="600">Semi Bold</option>
          <option value="700">Bold</option>
          <option value="100">100 - Thin</option>
          <option value="200">200 - Extra Light</option>
          <option value="300">300 - Light</option>
          <option value="400">400 - Normal</option>
          <option value="500">500 - Medium</option>
          <option value="800">800 - Extra Bold</option>
          <option value="900">900 - Black</option>
        </select>
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Align</span>
        <select id="common-text-align" class="editor-select">
          <option value="">Default</option>
          <option value="left">Left</option>
          <option value="center">Center</option>
          <option value="right">Right</option>
          <option value="justify">Justify</option>
        </select>
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Line Height</span>
        <input type="text" id="common-line-height" class="editor-input" placeholder="1.5">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Letter Spacing</span>
        <input type="text" id="common-letter-spacing" class="editor-input" placeholder="0px">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Decoration</span>
        <select id="common-text-decoration" class="editor-select">
          <option value="">Default</option>
          <option value="none">None</option>
          <option value="underline">Underline</option>
          <option value="overline">Overline</option>
          <option value="line-through">Strike-through</option>
        </select>
      </div>
    </div>

    <!-- Content Section -->
    <div class="editor-section">
      <div class="editor-section-title">Content</div>
      
      <div class="editor-row">
        <span class="editor-label">Text</span>
        <input type="text" id="common-content" class="editor-input" placeholder="Enter content">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Padding</span>
        <input type="text" id="common-padding" class="editor-input" placeholder="10px">
      </div>
    </div>

    <!-- Spacing & Layout Section -->
    <div class="editor-section">
      <div class="editor-section-title">Spacing & Layout</div>
      
      <div class="editor-row">
        <span class="editor-label">Margin</span>
        <input type="text" id="common-margin" class="editor-input" placeholder="0px">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Position</span>
        <select id="common-position" class="editor-select">
          <option value="">Default</option>
          <option value="static">Static</option>
          <option value="relative">Relative</option>
          <option value="absolute">Absolute</option>
          <option value="fixed">Fixed</option>
          <option value="sticky">Sticky</option>
        </select>
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Z-Index</span>
        <input type="number" id="common-z-index" class="editor-input" placeholder="0">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Display</span>
        <select id="common-display" class="editor-select">
          <option value="">Default</option>
          <option value="block">Block</option>
          <option value="inline">Inline</option>
          <option value="inline-block">Inline Block</option>
          <option value="flex">Flex</option>
          <option value="grid">Grid</option>
          <option value="none">Hidden</option>
        </select>
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Overflow</span>
        <select id="common-overflow" class="editor-select">
          <option value="">Default</option>
          <option value="visible">Visible</option>
          <option value="hidden">Hidden</option>
          <option value="scroll">Scroll</option>
          <option value="auto">Auto</option>
        </select>
      </div>
    </div>

    <!-- Specific Properties - Show based on element type -->
    
    <!-- Form Element Properties -->
    <div id="form-properties" class="editor-section specific-properties">
      <div class="editor-section-title">Form Settings</div>
      
      <div class="editor-row">
        <input type="checkbox" id="form-interactive-new" class="editor-checkbox">
        <span class="editor-label">Enable Interaction</span>
      </div>
    </div>

    <!-- Media Element Properties -->
    <div id="media-properties" class="editor-section specific-properties">
      <div class="editor-section-title">Media Settings</div>
      
      <div class="editor-row">
        <span class="editor-label">Source</span>
        <input type="text" id="media-src-new" class="editor-input" placeholder="URL or upload">
      </div>
      
      <div class="editor-row">
        <input type="file" id="media-upload-new" accept="image/*,video/*,audio/*" style="display: none;">
        <button onclick="document.getElementById('media-upload-new').click()" class="editor-button">Upload File</button>
      </div>
      
      <div class="editor-row">
        <input type="checkbox" id="media-controls-new" class="editor-checkbox" checked>
        <span class="editor-label">Show Controls</span>
      </div>
      
      <div class="editor-row">
        <input type="checkbox" id="media-autoplay-new" class="editor-checkbox">
        <span class="editor-label">Autoplay</span>
      </div>
    </div>

    <!-- Link Properties -->
    <div id="link-properties" class="editor-section specific-properties">
      <div class="editor-section-title">Link Settings</div>
      
      <div class="editor-row">
        <span class="editor-label">URL</span>
        <input type="text" id="link-href-new" class="editor-input" placeholder="https://example.com">
      </div>
      
      <div class="editor-row">
        <span class="editor-label">Target</span>
        <select id="link-target-new" class="editor-select">
          <option value="_self">Same Window</option>
          <option value="_blank">New Window</option>
        </select>
      </div>
    </div>

    <!-- Table Properties -->
    <div id="table-properties" class="editor-section specific-properties">
      <div class="editor-section-title">Table Settings</div>
      
      <button id="add-table-column" class="editor-button">+ Add Column</button>
      <button id="add-table-row" class="editor-button">+ Add Row</button>
      <button id="drop-entire-table" class="editor-button danger">üóëÔ∏è Drop Entire Table</button>
      
      <div id="table-editor" style="margin-top: 12px; max-height: 150px; overflow: auto;">
        <!-- Table cells will be dynamically generated here -->
      </div>
    </div>

    <!-- List Properties -->
    <div id="list-properties" class="editor-section specific-properties">
      <div class="editor-section-title">List Settings</div>
      
      <button id="add-list-item" class="editor-button">+ Add Item</button>
      <button id="drop-entire-list" class="editor-button danger">üóëÔ∏è Drop Entire List</button>
      
      <div id="list-editor" style="margin-top: 12px; max-height: 150px; overflow: auto;">
        <!-- List items will be dynamically generated here -->
      </div>
    </div>

    <!-- Actions -->
    <div class="editor-section">
      <button onclick="applyCommonChanges()" class="editor-button">Apply Changes</button>
      <button onclick="deleteSelectedElement()" class="editor-button danger">Delete Element</button>
    </div>
  </div>

  <div class="lay-out-body">
    <span class="layout-label"></span>
    <div id="resizable-element" class="lay-out" >
      <div id="v-guide" class="guide-line"></div>
      <div id="h-guide" class="guide-line"></div>
    </div>
  </div>

  <!--describes distance from a dragable to the horizontal or vertical middle of the page-->
  <div id="alignment-tooltip" style="
    position: absolute;
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    padding: 2px 6px;
    font-size: 12px;
    border-radius: 4px;
    display: none;
    pointer-events: none;
    z-index: 1002;"></div>

    <div class="palette">
      <div class="item-grid">
        <div class="item" onclick="toggleContent(this)">>  Text</div>
          <div class="content">
            <div id="h1" class="drag-item">heading 1</div>
            <div id="h2" class="drag-item">heading 2</div>
            <div id="h3" class="drag-item">heading 3</div>
            <div id="h4" class="drag-item">heading 4</div>
            <div id="h5" class="drag-item">heading 5</div>
            <div id="h6" class="drag-item">heading 6</div>
            <div id="p" class="drag-item">paragraph</div>
            <div id="span" class="drag-item">inline text</div>
            <div id="a" class="drag-item">link</div>
            <div id="hr" class="drag-item">divider</div>
          </div>
        <div class="item" onclick="toggleContent(this)">>  Forms</div>
          <div class="content">
            <div id="input" class="drag-item">input</div>
            <div id="textarea" class="drag-item">textarea</div>
            <div id="select" class="drag-item">select</div>
            <div id="checkbox" class="drag-item">checkbox</div>
            <div id="radio" class="drag-item">radio</div>
            <div id="button" class="drag-item">button</div>
          </div>
        <div class="item" onclick="toggleContent(this)">>  Media</div>
          <div class="content">
            <div id="img" class="drag-item">image</div>
            <div id="audio" class="drag-item">audio</div>
            <div id="video" class="drag-item">video</div>
            <div id="iframe" class="drag-item">embed</div>
          </div>
        <div class="item" onclick="toggleContent(this)">>  Lay-Out</div>
          <div class="content">
            <div id="div" class="drag-item">div</div>
            <div id="section" class="drag-item">section</div>
            <div id="article" class="drag-item">article</div>
            <div id="aside" class="drag-item">aside</div>
            <div id="nav" class="drag-item">nav</div>
            <div id="header" class="drag-item">header</div>
            <div id="footer" class="drag-item">footer</div>
          </div>
        <div class="item" onclick="toggleContent(this)">>  Lists</div>
          <div class="content">
            <div id="ul" class="drag-item">unordered list</div>
            <div id="ol" class="drag-item">ordered list</div>
          </div>
        <div class="item" onclick="toggleContent(this)">>  Data-Representation</div>
          <div class="content">
            <div id="table" class="drag-item">table</div>
          </div>

      </div>
    </div>

</div>

<!--///////////////////////divs and sections-->
  
  <!-- Preferences Modal -->
  <div id="preferences-modal" class="preferences-modal" style="display: none;">
    <div class="preferences-content">
      <div class="preferences-header">
        <h2>Code Generation Preferences</h2>
        <button onclick="closePreferences()" class="close-btn">√ó</button>
      </div>
      
      <div class="preferences-body">
        <div class="preference-group">
          <label for="pref-framework">Framework:</label>
          <select id="pref-framework">
            <option value="react">React</option>
            <option value="vue">Vue</option>
            <option value="angular">Angular</option>
            <option value="html">HTML/CSS</option>
            <option value="svelte">Svelte</option>
          </select>
        </div>

        <div class="preference-group">
          <label for="pref-language">Language:</label>
          <select id="pref-language">
            <option value="typescript">TypeScript</option>
            <option value="javascript">JavaScript</option>
          </select>
        </div>

        <div class="preference-group">
          <label for="pref-css-framework">CSS Framework:</label>
          <select id="pref-css-framework">
            <option value="none">None</option>
            <option value="tailwind">Tailwind CSS</option>
            <option value="bootstrap">Bootstrap</option>
            <option value="bulma">Bulma</option>
            <option value="chakra">Chakra UI</option>
            <option value="material">Material-UI</option>
          </select>
        </div>

        <div class="preference-group">
          <label for="pref-component-library">Component Library:</label>
          <select id="pref-component-library">
            <option value="none">None</option>
            <option value="antd">Ant Design</option>
            <option value="mui">Material-UI</option>
            <option value="chakra">Chakra UI</option>
            <option value="mantine">Mantine</option>
            <option value="reactstrap">Reactstrap</option>
          </select>
        </div>

        <div class="preference-group">
          <label for="pref-export-format">Export Format:</label>
          <select id="pref-export-format">
            <option value="component">Component</option>
            <option value="page">Full Page</option>
            <option value="snippet">Code Snippet</option>
          </select>
        </div>

        <div class="preference-group checkbox-group">
          <label>
            <input type="checkbox" id="pref-use-typescript" checked>
            Use TypeScript (when available)
          </label>
        </div>

        <div class="preference-group checkbox-group">
          <label>
            <input type="checkbox" id="pref-responsive">
            Generate responsive code
          </label>
        </div>

        <div class="preference-group checkbox-group">
          <label>
            <input type="checkbox" id="pref-accessibility">
            Include accessibility attributes
          </label>
        </div>
      </div>

      <div class="preferences-footer">
        <button onclick="savePreferences()" class="save-btn">Save Preferences</button>
        <button onclick="resetPreferences()" class="reset-btn">Reset to Defaults</button>
      </div>
    </div>
  </div>
  
  <div id="context-menu" class="context-menu" style="display: none;">
    <!-- Old context menu - now hidden as we use the new editor panel -->
  </div>
  
  <div id="context-menu-media" class="context-menu" style="display: none;">
    <!-- Old media context menu - now hidden as we use the new editor panel -->
  </div>
  
  <div id="context-menu-table" class="context-menu" style="display: none;">
    <!-- Old table context menu - now hidden as we use the new editor panel -->
  </div>
  
  <div id="context-menu-list" class="context-menu" style="display: none;">
    <!-- Old list context menu - now hidden as we use the new editor panel -->
  </div>

</body>  
<script>
const resizableElement = document.getElementById("resizable-element");

document.addEventListener("DOMContentLoaded", () => {
  const savedLayout = localStorage.getItem("deviceLayout");
  if (savedLayout) {
    const { width, height, label } = JSON.parse(savedLayout);
    applyLayout(width, height, label);
  } else {
    resizeToLaptop(); // default
  }
});

function applyLayout(width, height, label) {
  const resizableElement = document.getElementById("resizable-element");
  if (!resizableElement) return;

  resizableElement.style.width = width;
  resizableElement.style.height = height;

  const labelElement = resizableElement.querySelector(".layout-label");
  if (labelElement) {
    labelElement.innerText = label;
  }
}

function saveLayout(width, height, label="") {
  localStorage.setItem("deviceLayout", JSON.stringify({ width, height, label }));
}

function resizeToPhone(e) {
  const width = "50%";
  const height = "105%";
  const label = "PhoneView";
  applyLayout(width, height, label);
  saveLayout(width, height, label);
  if (e) e.preventDefault();
}

function resizeToLaptop(e) {
  const width = "99%";
  const height = "98%";
  const label = "LaptopView";
  applyLayout(width, height, label);
  saveLayout(width, height, label);
  if (e) e.preventDefault();
}


    //method to make sure palette size is perfect
    function toggleContent(element) {
      var content = element.nextElementSibling;
      content.style.display = content.style.display === "block" ? "none" : "block";
    }

    // Initialize drag and drop functionality,
    /*document.addEventListener('DOMContentLoaded', ...) is 
    used to initialize your JavaScript logic only after the HTML is ready */
    document.addEventListener('DOMContentLoaded', function() { 
      loadDroppedElements();
      // Make all palette items draggable
      document.querySelectorAll('.drag-item').forEach(item => {
        item.setAttribute('draggable', 'true'); // make item dragable using htlm5
        item.addEventListener('dragstart', handlePaletteDragStart); // when  you start dragging item the func is called
        item.addEventListener('contextmenu', handleContextMenu); // when you right click an item the func is called
        item.addEventListener('click', handleElementClick); // when you click an item the func is called
      } );

      // Make the resizable element a drop zone
      resizableElement.addEventListener('dragover', handleDragOver);
      resizableElement.addEventListener('drop', handleDrop);
      

      // Initialize Interact.js for resizing and dragging within the layout
      interact('.dropped-element')
        .draggable({
          inertia: false,
          modifiers: [
            interact.modifiers.restrictRect({
              restriction: 'parent',
              endOnly: true
            })
          ],
          autoScroll: true,
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

              // Translate the element
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
              checkAlignment(event.target);
              has_Parent(event.target);
              saveDroppedElements();
            }
            ,end(event) {
              document.getElementById('v-guide').style.display = 'none';
              document.getElementById('h-guide').style.display = 'none';
              document.getElementById('alignment-tooltip').style.display = 'none';
              saveDroppedElements();
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: true },
          listeners: {
            move(event) {
              let { target } = event;
              
              // Get current position
              let x = (parseFloat(target.getAttribute('data-x')) || 0);
              let y = (parseFloat(target.getAttribute('data-y')) || 0);

              // Update the element's size
              target.style.width = `${event.rect.width}px`;
              target.style.height = `${event.rect.height}px`;

              // Adjust position when resizing from left or top edges
              // event.deltaRect contains the change in position and size
              x += event.deltaRect.left;
              y += event.deltaRect.top;

              // Apply the new position and size
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
              
              checkAlignment(event.target);
              saveDroppedElements();
            },
            end(event){
              has_Parent(event.target);
            }
          }
        });
    } );

    function saveDroppedElements() {
      const elements = [];
      // Only save top-level elements (not nested children)
      document.querySelectorAll('#resizable-element > .dropped-element').forEach(el => {
        elements.push({
          html: el.innerHTML, // save its content 
          id: el.id,
          x: el.getAttribute('data-x'),
          y: el.getAttribute('data-y'),
          type: el.tagName,
          
          // Save ALL CSS styles to prevent data loss
          styles: {
            // Position & Size
            width: el.style.width,
            height: el.style.height,
            position: el.style.position,
            left: el.style.left,
            top: el.style.top,
            transform: el.style.transform,
            zIndex: el.style.zIndex,
            
            // Appearance
            backgroundColor: el.style.backgroundColor,
            opacity: el.style.opacity,
            borderRadius: el.style.borderRadius,
            borderWidth: el.style.borderWidth,
            borderColor: el.style.borderColor,
            borderStyle: el.style.borderStyle,
            border: el.style.border,
            
            // Effects
            boxShadow: el.style.boxShadow,
            textShadow: el.style.textShadow,
            
            // Typography
            color: el.style.color,
            fontFamily: el.style.fontFamily,
            fontSize: el.style.fontSize,
            fontWeight: el.style.fontWeight,
            textAlign: el.style.textAlign,
            lineHeight: el.style.lineHeight,
            letterSpacing: el.style.letterSpacing,
            textDecoration: el.style.textDecoration,
            
            // Spacing
            padding: el.style.padding,
            margin: el.style.margin,
            paddingTop: el.style.paddingTop,
            paddingRight: el.style.paddingRight,
            paddingBottom: el.style.paddingBottom,
            paddingLeft: el.style.paddingLeft,
            marginTop: el.style.marginTop,
            marginRight: el.style.marginRight,
            marginBottom: el.style.marginBottom,
            marginLeft: el.style.marginLeft,
            
            // Layout
            display: el.style.display,
            overflow: el.style.overflow,
            minWidth: el.style.minWidth,
            minHeight: el.style.minHeight,
            maxWidth: el.style.maxWidth,
            maxHeight: el.style.maxHeight,
            
            // Flexbox
            flexDirection: el.style.flexDirection,
            justifyContent: el.style.justifyContent,
            alignItems: el.style.alignItems,
            flex: el.style.flex,
            
            // Other common properties
            outline: el.style.outline,
            cursor: el.style.cursor,
            pointerEvents: el.style.pointerEvents,
            userSelect: el.style.userSelect,
            visibility: el.style.visibility,
            
            // Additional comprehensive properties
            float: el.style.float,
            clear: el.style.clear,
            textIndent: el.style.textIndent,
            wordSpacing: el.style.wordSpacing,
            whiteSpace: el.style.whiteSpace,
            verticalAlign: el.style.verticalAlign,
            listStyle: el.style.listStyle,
            listStyleType: el.style.listStyleType,
            listStylePosition: el.style.listStylePosition,
            listStyleImage: el.style.listStyleImage,
            tableLayout: el.style.tableLayout,
            borderCollapse: el.style.borderCollapse,
            borderSpacing: el.style.borderSpacing,
            captionSide: el.style.captionSide,
            emptyCells: el.style.emptyCells,
            resize: el.style.resize,
            filter: el.style.filter,
            backdropFilter: el.style.backdropFilter,
            clipPath: el.style.clipPath,
            mask: el.style.mask,
            objectFit: el.style.objectFit,
            objectPosition: el.style.objectPosition,
            mixBlendMode: el.style.mixBlendMode,
            isolation: el.style.isolation,
            willChange: el.style.willChange,
            contain: el.style.contain
          },
          
          // Save element-specific attributes
          attributes: {
            href: el.href || null,
            target: el.target || null,
            src: el.src || null,
            alt: el.alt || null,
            placeholder: el.placeholder || null,
            value: el.value || null,
            checked: el.checked || null,
            disabled: el.disabled || null,
            readOnly: el.readOnly || null,
            controls: el.controls || null,
            autoplay: el.autoplay || null,
            className: el.className,
            title: el.title || null,
            
            // Additional attributes for comprehensive saving
            id: el.id,
            name: el.name || null,
            type: el.type || null,
            rows: el.rows || null,
            cols: el.cols || null,
            maxLength: el.maxLength || null,
            min: el.min || null,
            max: el.max || null,
            step: el.step || null,
            pattern: el.pattern || null,
            required: el.required || null,
            multiple: el.multiple || null,
            selected: el.selected || null,
            tabIndex: el.tabIndex || null,
            accessKey: el.accessKey || null,
            contentEditable: el.contentEditable || null,
            draggable: el.draggable || null,
            hidden: el.hidden || null,
            lang: el.lang || null,
            spellcheck: el.spellcheck || null,
            translate: el.translate || null,
            dir: el.dir || null,
            role: el.getAttribute('role') || null,
            'aria-label': el.getAttribute('aria-label') || null,
            'aria-describedby': el.getAttribute('aria-describedby') || null,
            'data-custom': el.getAttribute('data-custom') || null
          }
        });
      });
      const storageKey = window.LOCAL_STORAGE_KEY || 'dropped_Elements';
      localStorage.setItem(storageKey, JSON.stringify(elements));
    }

    function loadDroppedElements() {
      // Clear existing elements first
      document.querySelectorAll('.dropped-element').forEach(el => el.remove());
      
      const storageKey = window.LOCAL_STORAGE_KEY || 'dropped_Elements';
      const saved = localStorage.getItem(storageKey);
      if (!saved) return;

      const elements = JSON.parse(saved);
      console.log(JSON.stringify(elements, null, 2)); // Show the saved elements for debugging
      
      elements.forEach(data => {
        let typeOfData = data.type.toLowerCase();
        console.log(`Loading element of type: ${typeOfData}`);
        
        const el = document.createElement(typeOfData);
        el.setAttribute('draggable', 'true');
        el.addEventListener('dragstart', handlePaletteDragStart);
        el.addEventListener('contextmenu', handleContextMenu);
        el.addEventListener('click', handleElementClick);
        el.classList.add('dropped-element');
        el.id = data.id;
        el.innerHTML = data.html;
        
        // Restore all CSS styles
        if (data.styles) {
          Object.keys(data.styles).forEach(property => {
            if (data.styles[property]) {
              el.style[property] = data.styles[property];
            }
          });
        } else {
          // Fallback for old save format
          el.style.position = 'absolute';
          el.style.width = data.width || '';
          el.style.height = data.height || '';
          el.style.color = data.color || '';
          el.style.backgroundColor = data.bgColor || '#ffffff';
          el.style.left = '0px';
          el.style.top = '0px';
        }
        
        // Restore position attributes
        el.style.transform = `translate(${data.x}px, ${data.y}px)`;
        el.setAttribute('data-x', data.x);
        el.setAttribute('data-y', data.y);
        
        // Restore element-specific attributes
        if (data.attributes) {
          Object.keys(data.attributes).forEach(attr => {
            const value = data.attributes[attr];
            if (value !== null && value !== undefined) {
              if (attr === 'className') {
                el.className = value;
              } else if (attr === 'checked' || attr === 'disabled' || attr === 'readOnly' || 
                         attr === 'controls' || attr === 'autoplay' || attr === 'required' || 
                         attr === 'multiple' || attr === 'selected' || attr === 'hidden' || 
                         attr === 'spellcheck' || attr === 'translate' || attr === 'draggable') {
                el[attr] = value;
              } else if (attr.startsWith('aria-') || attr.startsWith('data-') || attr === 'role') {
                el.setAttribute(attr, value);
              } else {
                el[attr] = value;
              }
            }
          });
        }
        
        resizableElement.appendChild(el);
        
        // Re-apply event listeners to any nested children
        el.querySelectorAll('.dropped-element').forEach(child => {
          child.setAttribute('draggable', 'true');
          child.addEventListener('dragstart', handlePaletteDragStart);
          child.addEventListener('contextmenu', handleContextMenu);
          child.addEventListener('click', handleElementClick);
          interact(child); // reapply interact.js to nested children
        });
        
        interact(el); // reapply interact.js to main element
      });
    }


    // checkalign variable
    let currentlyDragged=null;
    // Handle drag start from palette
    function handlePaletteDragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.id);
      e.dataTransfer.effectAllowed = 'copy';
      currentlyDragged = e.target;
    }

    // Handle drag over we need to save state
    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      saveDroppedElements();
      if(currentlyDragged){
        checkAlignment(currentlyDragged);
      }
    }


function checkAlignment(dragable) {
  const vGuide = document.getElementById('v-guide');
  const hGuide = document.getElementById('h-guide');
  const tooltip = document.getElementById('alignment-tooltip');
  const dropRect = resizableElement.getBoundingClientRect();
  const dragRect = dragable.getBoundingClientRect();
  const tolerance = 5;

  // Drag element edges and center
  const dragLeft = dragRect.left;
  const dragRight = dragRect.right;
  const dragTop = dragRect.top;
  const dragBottom = dragRect.bottom;
  const dragCenterX = dragLeft + dragRect.width / 2;
  const dragCenterY = dragTop + dragRect.height / 2;

  // Container edges and center
  const dropLeft = dropRect.left;
  const dropRight = dropRect.right;
  const dropTop = dropRect.top;
  const dropBottom = dropRect.bottom;
  const dropCenterX = dropLeft + dropRect.width / 2;
  const dropCenterY = dropTop + dropRect.height / 2;

  vGuide.style.display = 'none';
  hGuide.style.display = 'none';
  tooltip.style.display = 'none';

  let dxInfo = '';
  let dyInfo = '';

  // Center alignment with container
  if (Math.abs(dragCenterX - dropCenterX) < tolerance) {
    vGuide.style.left = `${dropCenterX - dropLeft}px`;
    vGuide.style.display = 'block';
  } else {
    dxInfo = `‚Üî ${Math.abs(dragCenterX - dropCenterX).toFixed(0)}px`;
  }

  if (Math.abs(dragCenterY - dropCenterY) < tolerance) {
    hGuide.style.top = `${dropCenterY - dropTop}px`;
    hGuide.style.display = 'block';
  } else {
    dyInfo = `‚Üï ${Math.abs(dragCenterY - dropCenterY).toFixed(0)}px`;
  }

  // Edge alignment with container
  if (Math.abs(dragLeft - dropLeft) < tolerance) {
    vGuide.style.left = '0px';
    vGuide.style.display = 'block';
  }
  if (Math.abs(dragRight - dropRight) < tolerance) {
    vGuide.style.left = `${dropRect.width - 1}px`;
    vGuide.style.display = 'block';
  }
  if (Math.abs(dragTop - dropTop) < tolerance) {
    hGuide.style.top = '0px';
    hGuide.style.display = 'block';
  }
  if (Math.abs(dragBottom - dropBottom) < tolerance) {
    hGuide.style.top = `${dropRect.height - 1}px`;
    hGuide.style.display = 'block';
  }

  // Align with other dropped elements
  document.querySelectorAll('.dropped-element').forEach(el => {
    if (el === dragable) return;

    const rect = el.getBoundingClientRect();
    const tLeft = rect.left;
    const tRight = rect.right;
    const tTop = rect.top;
    const tBottom = rect.bottom;
    const tCenterX = tLeft + rect.width / 2;
    const tCenterY = tTop + rect.height / 2;

    if (Math.abs(dragCenterX - tCenterX) < tolerance) {
      vGuide.style.left = `${tCenterX - dropLeft}px`;
      vGuide.style.display = 'block';
    }

    if (Math.abs(dragCenterY - tCenterY) < tolerance) {
      hGuide.style.top = `${tCenterY - dropTop}px`;
      hGuide.style.display = 'block';
    }

    if (Math.abs(dragLeft - tLeft) < tolerance) {
      vGuide.style.left = `${tLeft - dropLeft}px`;
      vGuide.style.display = 'block';
    }
    if (Math.abs(dragRight - tRight) < tolerance) {
      vGuide.style.left = `${tRight - dropLeft}px`;
      vGuide.style.display = 'block';
    }
    if (Math.abs(dragLeft - tRight) < tolerance) {
      vGuide.style.left = `${tRight - dropLeft}px`;
      vGuide.style.display = 'block';
    }
    if (Math.abs(dragRight - tLeft) < tolerance) {
      vGuide.style.left = `${tLeft - dropLeft}px`;
      vGuide.style.display = 'block';
    }

    if (Math.abs(dragTop - tTop) < tolerance) {
      hGuide.style.top = `${tTop - dropTop}px`;
      hGuide.style.display = 'block';
    }
    if (Math.abs(dragBottom - tBottom) < tolerance) {
      hGuide.style.top = `${tBottom - dropTop}px`;
      hGuide.style.display = 'block';
    }
    if (Math.abs(dragTop - tBottom) < tolerance) {
      hGuide.style.top = `${tBottom - dropTop}px`;
      hGuide.style.display = 'block';
    }
    if (Math.abs(dragBottom - tTop) < tolerance) {
      hGuide.style.top = `${tTop - dropTop}px`;
      hGuide.style.display = 'block';
    }
  });

  // Show tooltip near element
  if (dxInfo || dyInfo) {
    tooltip.innerText = `${dxInfo} ${dyInfo}`.trim();
    tooltip.style.left = `${dragRect.right + 10}px`;
    tooltip.style.top = `${dragRect.top}px`;
    tooltip.style.display = 'block';
  } else {
    tooltip.style.display = 'none';
  }
}

/*checks if a dragged item became a child of another dragable based on position and size;
function has_Parent(dragable) {
  const dRect = dragable.getBoundingClientRect();
  const allDragables = document.querySelectorAll('.dropped-element');

  allDragables.forEach((parent) => {
    if (parent === dragable || parent.contains(dragable)) return;

    const pRect = parent.getBoundingClientRect();
    const fullyContained =
      pRect.left <= dRect.left &&
      pRect.top <= dRect.top &&
      pRect.right >= dRect.right &&
      pRect.bottom >= dRect.bottom;

    if (fullyContained) {
      parent.appendChild(dragable);
      const childArray = parent.childNodes; //[child1,child2,...];
      childArray.forEach((child)=>{
        if(child.nodeType === Node.ELEMENT_NODE){
          child.setAttribute('draggable', 'true'); // make item dragable using htlm5
          child.addEventListener('contextmenu', handleContextMenu); // when you right click an item the func is called}
      }});

      saveDroppedElements();
    } 
  });
} */

function has_Parent(dragable) {
  const dRect = dragable.getBoundingClientRect();
  const allDragables = document.querySelectorAll('.dropped-element');
  const root = document.getElementById('resizable-element');
  let nested = false;

  // remove outside duplicate copy
  const removeCopy =()=>{
    allDragables.forEach((duplicate)=>{
      if(duplicate.id === dragable.id && duplicate !== dragable && duplicate.parentNode !== dragable.parentNode){
        duplicate.parentNode.removeChild(duplicate);
      }
    })
  };

  allDragables.forEach((parent) => {
    if (parent === dragable) return;

    const pRect = parent.getBoundingClientRect();
    const fullyContained =
      pRect.left <= dRect.left &&
      pRect.top <= dRect.top &&
      pRect.right >= dRect.right &&
      pRect.bottom >= dRect.bottom;

    if (fullyContained) {
      // Only re-nest if not already nested inside this exact parent
      if (dragable.parentElement !== parent) {
        const offsetX = dRect.left - pRect.left;
        const offsetY = dRect.top - pRect.top;

        parent.appendChild(dragable);
        parent.style.position = parent.style.position || 'relative';

        dragable.style.position = 'absolute';
        dragable.style.left = '0';
        dragable.style.top = '0';
        dragable.setAttribute('data-x', offsetX);
        dragable.setAttribute('data-y', offsetY);
        dragable.style.transform = `translate(${offsetX}px, ${offsetY}px)`;

        // Re-enable drag + context menu
        parent.childNodes.forEach((child) => {
          if (child.nodeType === Node.ELEMENT_NODE) {
            child.setAttribute('draggable', 'true');
            child.removeEventListener('contextmenu', handleContextMenu);
            child.addEventListener('contextmenu', handleContextMenu);
            child.addEventListener('click', handleElementClick);
          }
        });
        removeCopy();
        saveDroppedElements();
      }

      nested = true;

    }
  });

  // If it was inside a parent but no longer contained => un-nest
  const currentParent = dragable.parentElement;
  if (!nested && currentParent && currentParent !== root && currentParent.classList.contains('dropped-element')) {
    const offsetX = dRect.left - root.getBoundingClientRect().left;
    const offsetY = dRect.top - root.getBoundingClientRect().top;

    root.appendChild(dragable);
    dragable.style.position = 'absolute';
    dragable.style.left = '0';
    dragable.style.top = '0';
    dragable.setAttribute('data-x', offsetX);
    dragable.setAttribute('data-y', offsetY);
    dragable.style.transform = `translate(${offsetX}px, ${offsetY}px)`;

    saveDroppedElements();
  }
  removeCopy();
  saveDroppedElements();
}







    /* Handle drop within palette
    function handlePaletteDrop(e) {
      e.preventDefault();
      
      const elementId = e.dataTransfer.getData('text/plain');
      const draggedElement = document.getElementById(elementId);
      const dropTarget = e.target.closest('.content');
      
      if (dropTarget && draggedElement) {
        dropTarget.appendChild(draggedElement);
      }
    } */

    // Handle drop on the resizable element
    function handleDrop(e) {
      e.preventDefault();
      const elementId = e.dataTransfer.getData('text/plain');
      const rect = resizableElement.getBoundingClientRect();
      const x = e.clientX - rect.left ;
      const y = e.clientY - rect.top;
      
      const newElement = createElementByType(elementId);
      
      if (newElement) {
        newElement.style.position = 'absolute';
        //newElement.style.left = x + 'px';
        //newElement.style.top = y + 'px';

        newElement.style.left = '0px';
        newElement.style.top = '0px';
        newElement.style.transform = `translate(${x}px, ${y}px)`;
        newElement.setAttribute('data-x', x);
        newElement.setAttribute('data-y', y);
        
        newElement.addEventListener('contextmenu', handleContextMenu);
        newElement.addEventListener('click', handleElementClick);
        
        resizableElement.appendChild(newElement);
      }
      saveDroppedElements();

    }

    // create ID for each dragable
    let elementCounter = 1;
    // Generate unique ID
    function generateUniqueId() {
      while (document.getElementById(`element-${elementCounter}`)) {
        elementCounter++;
      }
      return `element-${elementCounter++}`;
    }

    // Create a new element based on the type
    function createElementByType(type) {
      let element;
      
      switch(type) {
        case 'h1':
          element = document.createElement('h1');
          element.textContent = 'Heading 1';
          break;
        case 'h2':
          element = document.createElement('h2');
          element.textContent = 'Heading 2';
          break;
        case 'h3':
          element = document.createElement('h3');
          element.textContent = 'Heading 3';
          break;
        case 'h4':
          element = document.createElement('h4');
          element.textContent = 'Heading 4';
          break;
        case 'h5':
          element = document.createElement('h5');
          element.textContent = 'Heading 5';
          break;
        case 'h6':
          element = document.createElement('h6');
          element.textContent = 'Heading 6';
          break;
        case 'p':
          element = document.createElement('p');
          element.textContent = 'Paragraph text';
          break;
        case 'input':
          element = document.createElement('input');
          element.type = 'text';
          element.placeholder = 'Input field';
          break;
        case 'textarea':
          element = document.createElement('textarea');
          element.placeholder = 'Text area';
          break;
        case 'select':
          element = document.createElement('select');
          element.innerHTML = '<option>Option 1</option><option>Option 2</option>';
          break;
        case 'checkbox':
          element = document.createElement('input');
          element.type = 'checkbox';
          break;
        case 'radio':
          element = document.createElement('input');
          element.type = 'radio';
          break;
        case 'button':
          element = document.createElement('button');
          element.textContent = 'Button';
          break;
        case 'a':
          element = document.createElement('a');
          element.href = '#';
          element.textContent = 'Link';
          element.style.color = '#0066ff';
          element.style.textDecoration = 'underline';
          break;
        case 'iframe':
          element = document.createElement('iframe');
          element.src = 'about:blank';
          element.style.width = '300px';
          element.style.height = '200px';
          element.style.border = '1px solid #ccc';
          break;
        case 'span':
          element = document.createElement('span');
          element.textContent = 'Inline text';
          break;
        case 'hr':
          element = document.createElement('hr');
          element.style.border = '1px solid #ccc';
          element.style.width = '100%';
          break;
        case 'img':
          element = document.createElement('img');
          element.src = 'https://via.placeholder.com/150';
          element.alt = 'Image placeholder';
          break;
        case 'audio':
          element = document.createElement('audio');
          element.controls = true;
          element.innerHTML = 'Your browser does not support the audio element.';
          break;
        case 'video':
          element = document.createElement('video');
          element.controls = true;
          element.innerHTML = 'Your browser does not support the video element.';
          break;
        case 'div':
          element = document.createElement('div');
          element.textContent = 'Container';
          element.style.minHeight = '50px';
          element.style.minWidth = '100px';
          break;
        case 'section':
          element = document.createElement('section');
          element.innerHTML = '<section style="font-family: sans-serif; padding: 10px; border: 2px dashed #4CAF50;"><h2>Section Title</h2><p>This is a content section. Use it to group related content.</p></section>';
          element.style.minHeight = '50px';
          element.style.minWidth = '100px';
          break;
        case 'article':
          element = document.createElement('article');
          element.innerHTML = '<article style="font-family: sans-serif; padding: 10px; border: 1px solid #ccc;"><h2>Article Title</h2><p>This is a sample article summary.</p></article>';
          break;

        case 'aside':
          element = document.createElement('aside');
          element.innerHTML = '<aside style="font-family: sans-serif; padding: 10px; border-left: 4px solid #888;"><h3>Aside</h3><p>Supplementary info here.</p></aside>';
          break;

        case 'nav':
          element = document.createElement('nav');
          element.innerHTML = '<nav style="font-family: sans-serif; padding: 10px; background: #f5f5f5;"><ul style="list-style: none; padding: 0;"><li><a href="#">Home</a></li><li><a href="#">About</a></li></ul></nav>';
          break;

        case 'header':
          element = document.createElement('header');
          element.innerHTML = '<header style="font-family: sans-serif; padding: 10px; background: #007BFF; color: white;"><h1>Website Header</h1><p>Welcome message or logo area</p></header>';
          break;

        case 'footer':
          element = document.createElement('footer');
          element.innerHTML = '<footer style="font-family: sans-serif; padding: 10px; background: #222; color: white;"><p>&copy; 2025 Your Company. All rights reserved.</p></footer>';
          break;
        case 'ul':
          element = document.createElement('ul');
          element.innerHTML = '<li>Item 1</li><li>Item 2</li>';
          break;
        case 'ol':
          element = document.createElement('ol');
          element.innerHTML = '<li>Item 1</li><li>Item 2</li>';
          break;
        case 'table':
          element = document.createElement('table');
          element.innerHTML = '<table style="width:100%;border-collapse:collapse;font-family:sans-serif;box-shadow:0 0 10px rgba(0,0,0,0.1);"><thead><tr style="background-color:#007BFF;color:white;"><th style="padding:12px;border:1px solid #ddd;">Name</th><th style="padding:12px;border:1px solid #ddd;">Role</th></tr></thead><tbody><tr style="background-color:#f9f9f9;"><td style="padding:12px;border:1px solid #ddd;">Alice Johnson</td><td style="padding:12px;border:1px solid #ddd;">Software Engineer</td></tr></tbody></table>';
          element.style.border = '1px solid #ccc';
          break;
        default:
          element = document.createElement('div');
          element.textContent = type;
      }
      
      element.className = 'dropped-element';
      element.id = generateUniqueId();
      
      // Set default colors for better visibility, but preserve existing inline styles
      if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'section', 'article', 'aside', 'nav', 'header', 'footer'].includes(type)) {
        // Only set text color if not already set by innerHTML
        if (!element.style.color) {
          element.style.color = '#333'; // Dark text for readability
        }
      }
      
      // Only set white background for elements that don't have their own background
      // Check if the element has background styles in its innerHTML
      const hasInlineBackground = element.innerHTML.includes('background:') || 
                                 element.innerHTML.includes('background-color:') ||
                                 element.style.backgroundColor;
      
      if (!hasInlineBackground) {
        element.style.backgroundColor = '#ffffff';
      }
      
      return element;
    }

    /* Make an element resizable
    function makeElementResizable(element) {
      element.style.resize = 'both';
      element.style.overflow = 'auto';
    } */


    // Global variable to track selected element
    let currentSelectedElement = null;

    // Handle element selection (replaces right-click context menu)
    function selectElement(element) {
      // Remove previous selection highlight
      document.querySelectorAll('.dropped-element').forEach(el => {
        el.style.outline = 'none';
      });
      
      // Highlight selected element
      element.style.outline = '2px solid #0066ff';
      currentSelectedElement = element;
      
      // Update editor panel
      updateEditorPanel(element);
    }

    // Handle right-click context menu - now just selects element
    function handleContextMenu(e) {
      e.preventDefault();
      selectElement(e.target);
    }

    // Handle click to select element with smart container selection
    function handleElementClick(e) {
      e.stopPropagation();
      
      let targetElement = e.target;
      
      // Smart container selection: if clicking on table cell, select the table
      // if clicking on list item, select the list
      if (targetElement.tagName.toLowerCase() === 'td' || targetElement.tagName.toLowerCase() === 'th') {
        const table = targetElement.closest('table');
        if (table && table.classList.contains('dropped-element')) {
          targetElement = table;
        }
      } else if (targetElement.tagName.toLowerCase() === 'li') {
        const list = targetElement.closest('ul, ol');
        if (list && list.classList.contains('dropped-element')) {
          targetElement = list;
        }
      }
      
      selectElement(targetElement);
    }

    // Update the editor panel with element properties
    function updateEditorPanel(element) {
      const type = element.tagName.toLowerCase();
      let elementType = type;
      if (type === 'input' && element.type) {
        elementType = element.type;
      }

      // Show selection info
      document.getElementById('no-selection').style.display = 'none';
      document.getElementById('element-selected').style.display = 'block';
      document.getElementById('selected-element-type').textContent = elementType.toUpperCase();
      document.getElementById('selected-element-id').textContent = '#' + element.id;

      // Hide all specific property sections
      document.querySelectorAll('.specific-properties').forEach(section => {
        section.classList.remove('visible');
      });

      // Populate common properties
      document.getElementById('common-width').value = element.style.width || '';
      document.getElementById('common-height').value = element.style.height || '';
      document.getElementById('common-opacity').value = element.style.opacity || '1';
      document.getElementById('common-border-radius').value = element.style.borderRadius || '';
      document.getElementById('common-border-width').value = element.style.borderWidth || '';
      document.getElementById('common-padding').value = element.style.padding || '';
      document.getElementById('common-margin').value = element.style.margin || '';
      document.getElementById('common-box-shadow').value = element.style.boxShadow || '';
      document.getElementById('common-text-shadow').value = element.style.textShadow || '';
      document.getElementById('common-transform').value = element.style.transform || '';
      document.getElementById('common-position').value = element.style.position || '';
      document.getElementById('common-z-index').value = element.style.zIndex || '';
      document.getElementById('common-display').value = element.style.display || '';
      document.getElementById('common-overflow').value = element.style.overflow || '';

      // Handle colors
      let bgColor = element.style.backgroundColor;
      if (!bgColor || bgColor === 'transparent') {
        const computedStyle = window.getComputedStyle(element);
        bgColor = computedStyle.backgroundColor || '#ffffff';
      }
      if (bgColor.startsWith('rgb')) {
        bgColor = rgbToHex(bgColor);
      }
      document.getElementById('common-bg-color').value = bgColor.startsWith('#') ? bgColor : '#ffffff';

      let borderColor = element.style.borderColor;
      if (!borderColor) {
        const computedStyle = window.getComputedStyle(element);
        borderColor = computedStyle.borderColor || '#cccccc';
      }
      if (borderColor.startsWith('rgb')) {
        borderColor = rgbToHex(borderColor);
      }
      document.getElementById('common-border-color').value = borderColor.startsWith('#') ? borderColor : '#cccccc';

      let textColor = element.style.color;
      if (!textColor) {
        const computedStyle = window.getComputedStyle(element);
        textColor = computedStyle.color || '#000000';
      }
      if (textColor.startsWith('rgb')) {
        textColor = rgbToHex(textColor);
      }
      document.getElementById('common-text-color').value = textColor.startsWith('#') ? textColor : '#000000';

      // Typography
      document.getElementById('common-font-family').value = element.style.fontFamily || '';
      document.getElementById('common-font-size').value = element.style.fontSize || '';
      document.getElementById('common-font-weight').value = element.style.fontWeight || '';
      document.getElementById('common-text-align').value = element.style.textAlign || '';
      document.getElementById('common-line-height').value = element.style.lineHeight || '';
      document.getElementById('common-letter-spacing').value = element.style.letterSpacing || '';
      document.getElementById('common-text-decoration').value = element.style.textDecoration || '';

      // Content
      let contentValue = '';
      if(['input','textarea'].includes(elementType)){
        contentValue = element.value || element.placeholder || '';
        // Show form properties
        document.getElementById('form-properties').classList.add('visible');
        document.getElementById('form-interactive-new').checked = element.style.pointerEvents !== 'none';
      } else if(elementType === 'select'){
        contentValue = element.innerHTML;
        document.getElementById('form-properties').classList.add('visible');
        document.getElementById('form-interactive-new').checked = !element.disabled;
      } else {
        // Smart content extraction for different element types
        const tagName = element.tagName.toLowerCase();
        
        if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p'].includes(tagName)) {
          contentValue = element.textContent;
        } else if (['div', 'section', 'article', 'aside', 'nav', 'header', 'footer'].includes(tagName)) {
          const clonedElement = element.cloneNode(true);
          const childElements = clonedElement.querySelectorAll('*');
          childElements.forEach(child => child.remove());
          contentValue = clonedElement.textContent.trim();
          
          if (!contentValue) {
            const firstTextElement = element.querySelector('h1, h2, h3, h4, h5, h6, p');
            if (firstTextElement) {
              contentValue = firstTextElement.textContent;
            }
          }
        } else {
          contentValue = element.textContent;
        }
      }
      document.getElementById('common-content').value = contentValue;

      // Show specific properties based on element type
      if(['img', 'audio', 'video'].includes(type)){
        document.getElementById('media-properties').classList.add('visible');
        document.getElementById('media-src-new').value = element.src || '';
        document.getElementById('media-controls-new').checked = element.controls ?? true;
        document.getElementById('media-autoplay-new').checked = element.autoplay ?? false;
      }

      if(type === 'a'){
        document.getElementById('link-properties').classList.add('visible');
        document.getElementById('link-href-new').value = element.href || '';
        document.getElementById('link-target-new').value = element.target || '_self';
      }

      if(['table','tr','td','th'].includes(type)){
        const tableElement = element.closest('table');
        document.getElementById('table-properties').classList.add('visible');
        updateTableEditor(tableElement);
      }

      if (['ul', 'ol', 'li'].includes(type)) {
        const listElement = element.closest('ol') || element.closest('ul');
        document.getElementById('list-properties').classList.add('visible');
        updateListEditor(listElement);
      }
    }

    // Update table editor
    function updateTableEditor(tableElement) {
      const tableEditor = document.getElementById('table-editor');
      tableEditor.innerHTML = '';
      
      if (!tableElement) return;

      // Hook up add-column
      document.getElementById('add-table-column').onclick = () => {
        for (const row of tableElement.rows) {
          const cell = row.insertCell();
          cell.innerText = 'New Col';
          cell.style.padding = '8px';
          cell.style.border = '1px solid #ddd';
        }
        saveDroppedElements();
        updateTableEditor(tableElement);
      };

      // Hook up add-row
      document.getElementById('add-table-row').onclick = () => {
        const newRow = tableElement.insertRow();
        for (let i = 0; i < tableElement.rows[0].cells.length; i++) {
          const cell = newRow.insertCell();
          cell.innerText = 'New Row';
          cell.style.padding = '8px';
          cell.style.border = '1px solid #ddd';
        }
        saveDroppedElements();
        updateTableEditor(tableElement);
      };

      // Hook up drop entire table
      document.getElementById('drop-entire-table').onclick = () => {
        if (tableElement && tableElement.parentNode) {
          tableElement.parentNode.removeChild(tableElement);
          clearSelection();
          saveDroppedElements();
        }
      };

      // Create grid of inputs for each cell
      const gridContainer = document.createElement('div');
      gridContainer.style.display = 'grid';
      gridContainer.style.gridTemplateColumns = `repeat(${tableElement.rows[0].cells.length}, 1fr)`;
      gridContainer.style.gap = '4px';

      for (let r = 0; r < tableElement.rows.length; r++) {
        for (let c = 0; c < tableElement.rows[r].cells.length; c++) {
          const cell = tableElement.rows[r].cells[c];
          const input = document.createElement('input');
          input.type = 'text';
          input.value = cell.innerText;
          input.className = 'editor-input';
          input.style.fontSize = '10px';
          input.addEventListener('input', (e) => {
            tableElement.rows[r].cells[c].innerText = e.target.value;
            saveDroppedElements();
          });
          gridContainer.appendChild(input);
        }
      }
      tableEditor.appendChild(gridContainer);
    }

    // Update list editor
    function updateListEditor(listElement) {
      const listEditor = document.getElementById('list-editor');
      listEditor.innerHTML = '';
      
      if (!listElement) return;

      // Hook up add item
      document.getElementById('add-list-item').onclick = () => {
        const newItem = document.createElement('li');
        newItem.innerText = 'New list item';
        listElement.appendChild(newItem);
        saveDroppedElements();
        updateListEditor(listElement);
      };

      // Hook up drop entire list
      document.getElementById('drop-entire-list').onclick = () => {
        if (listElement && listElement.parentNode) {
          listElement.parentNode.removeChild(listElement);
          clearSelection();
          saveDroppedElements();
        }
      };

      // Create inputs for each list item
      const listItems = listElement.querySelectorAll('li');
      listItems.forEach((li, index) => {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = li.innerText;
        input.className = 'editor-input';
        input.style.marginBottom = '4px';
        input.addEventListener('input', (e) => {
          li.innerText = e.target.value;
          saveDroppedElements();
        });
        listEditor.appendChild(input);
      });
    }

    // Clear selection when clicking outside
    function clearSelection() {
      if (currentSelectedElement) {
        currentSelectedElement.style.outline = 'none';
        currentSelectedElement = null;
      }
      
      // Hide selection info
      document.getElementById('no-selection').style.display = 'block';
      document.getElementById('element-selected').style.display = 'none';
      
      // Hide all specific properties
      document.querySelectorAll('.specific-properties').forEach(section => {
        section.classList.remove('visible');
      });
      
      // Clear common properties
      document.getElementById('common-width').value = '';
      document.getElementById('common-height').value = '';
      document.getElementById('common-opacity').value = '';
      document.getElementById('common-border-radius').value = '';
      document.getElementById('common-border-width').value = '';
      document.getElementById('common-padding').value = '';
      document.getElementById('common-margin').value = '';
      document.getElementById('common-box-shadow').value = '';
      document.getElementById('common-text-shadow').value = '';
      document.getElementById('common-transform').value = '';
      document.getElementById('common-content').value = '';
      document.getElementById('common-font-family').value = '';
      document.getElementById('common-font-size').value = '';
      document.getElementById('common-line-height').value = '';
      document.getElementById('common-letter-spacing').value = '';
      document.getElementById('common-position').value = '';
      document.getElementById('common-z-index').value = '';
      document.getElementById('common-display').value = '';
      document.getElementById('common-overflow').value = '';
    }

    // Apply changes from the new editor interface
    function applyCommonChanges() {
      if (!currentSelectedElement) return;

      const element = currentSelectedElement;
      
      // Apply common properties
      const width = document.getElementById('common-width').value;
      const height = document.getElementById('common-height').value;
      const bgColor = document.getElementById('common-bg-color').value;
      const opacity = document.getElementById('common-opacity').value;
      const borderRadius = document.getElementById('common-border-radius').value;
      const borderWidth = document.getElementById('common-border-width').value;
      const borderColor = document.getElementById('common-border-color').value;
      const boxShadow = document.getElementById('common-box-shadow').value;
      const textShadow = document.getElementById('common-text-shadow').value;
      const transform = document.getElementById('common-transform').value;
      
      // Typography
      const fontFamily = document.getElementById('common-font-family').value;
      const textColor = document.getElementById('common-text-color').value;
      const fontSize = document.getElementById('common-font-size').value;
      const fontWeight = document.getElementById('common-font-weight').value;
      const textAlign = document.getElementById('common-text-align').value;
      const lineHeight = document.getElementById('common-line-height').value;
      const letterSpacing = document.getElementById('common-letter-spacing').value;
      const textDecoration = document.getElementById('common-text-decoration').value;
      
      // Content and spacing
      const content = document.getElementById('common-content').value;
      const padding = document.getElementById('common-padding').value;
      const margin = document.getElementById('common-margin').value;
      const position = document.getElementById('common-position').value;
      const zIndex = document.getElementById('common-z-index').value;
      const display = document.getElementById('common-display').value;
      const overflow = document.getElementById('common-overflow').value;

      // Apply basic properties
      if (width) element.style.width = width;
      if (height) element.style.height = height;
      if (bgColor) element.style.backgroundColor = bgColor;
      if (opacity) element.style.opacity = opacity;
      if (borderRadius) element.style.borderRadius = borderRadius;
      if (borderWidth) element.style.borderWidth = borderWidth;
      if (borderColor) element.style.borderColor = borderColor;
      if (boxShadow) element.style.boxShadow = boxShadow;
      if (textShadow) element.style.textShadow = textShadow;
      if (transform) element.style.transform = transform;
      
      // Apply typography
      if (fontFamily) element.style.fontFamily = fontFamily;
      if (textColor) element.style.color = textColor;
      if (fontSize) element.style.fontSize = fontSize;
      if (fontWeight) element.style.fontWeight = fontWeight;
      if (textAlign) element.style.textAlign = textAlign;
      if (lineHeight) element.style.lineHeight = lineHeight;
      if (letterSpacing) element.style.letterSpacing = letterSpacing;
      if (textDecoration) element.style.textDecoration = textDecoration;
      
      // Apply spacing and layout
      if (padding) element.style.padding = padding;
      if (margin) element.style.margin = margin;
      if (position) element.style.position = position;
      if (zIndex) element.style.zIndex = zIndex;
      if (display) element.style.display = display;
      if (overflow) element.style.overflow = overflow;

      // Apply content
      const elementType = element.tagName.toLowerCase();
      if(['input','textarea'].includes(elementType)){
        element.value = content;
        element.placeholder = content;
        
        // Apply form settings
        const formInteractive = document.getElementById('form-interactive-new').checked;
        if(formInteractive) {
          element.style.pointerEvents = 'auto';
          element.readOnly = false;
        } else {
          element.style.pointerEvents = 'none';
          element.readOnly = true;
        }
      } else if(elementType === 'select'){
        if(content) element.innerHTML = `<option>${content}</option>`;
        
        const formInteractive = document.getElementById('form-interactive-new').checked;
        element.disabled = !formInteractive;
      } else if(elementType === 'a'){
        if(content) element.textContent = content;
        
        // Apply link settings
        const linkHref = document.getElementById('link-href-new').value;
        const linkTarget = document.getElementById('link-target-new').value;
        
        if(linkHref) element.href = linkHref;
        if(linkTarget) element.target = linkTarget;
      } else {
        // Handle content for other elements
        if (content && content !== '') {
          if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span'].includes(elementType)) {
            element.textContent = content;
          } else if (['div', 'section', 'article', 'aside', 'nav', 'header', 'footer'].includes(elementType)) {
            // Update direct text content
            let updatedDirectText = false;
            const childNodes = Array.from(element.childNodes);
            
            for (let node of childNodes) {
              if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                node.textContent = content;
                updatedDirectText = true;
                break;
              }
            }
            
            if (!updatedDirectText) {
              const firstTextElement = element.querySelector('h1, h2, h3, h4, h5, h6, p');
              if (firstTextElement) {
                firstTextElement.textContent = content;
              } else {
                const textNode = document.createTextNode(content + ' ');
                element.insertBefore(textNode, element.firstChild);
              }
            }
          } else {
            element.textContent = content;
          }
        }
      }

      // Apply media settings if applicable
      if(['img', 'audio', 'video'].includes(elementType)){
        const mediaSrc = document.getElementById('media-src-new').value;
        const mediaControls = document.getElementById('media-controls-new').checked;
        const mediaAutoplay = document.getElementById('media-autoplay-new').checked;

        if (mediaSrc) element.src = mediaSrc;
        if ('controls' in element) element.controls = mediaControls;
        if ('autoplay' in element) element.autoplay = mediaAutoplay;
      }

      saveDroppedElements();
    }

    // Delete selected element
    function deleteSelectedElement() {
      if (!currentSelectedElement) return;
      
      if (currentSelectedElement.parentNode) {
        currentSelectedElement.parentNode.removeChild(currentSelectedElement);
        clearSelection();
        saveDroppedElements();
      }
    }

    // Media upload handler
    document.getElementById('media-upload-new').addEventListener('change', function () {
      const file = this.files[0];
      if (file && currentSelectedElement) {
        const url = URL.createObjectURL(file);
        currentSelectedElement.src = url;
        document.getElementById('media-src-new').value = url;
        saveDroppedElements();
      }
    });

    // Clear selection when clicking on canvas
    document.getElementById('resizable-element').addEventListener('click', function(e) {
      if (e.target === this) {
        clearSelection();
      }
    });
    

// Helper function to convert RGB/RGBA colors to hex format
    function rgbToHex(rgb) {
      // Handle both rgb(r,g,b) and rgba(r,g,b,a) formats
      const match = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)|rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/);
      if (!match) return '#ffffff';
      
      const r = parseInt(match[1] || match[4]);
      const g = parseInt(match[2] || match[5]);
      const b = parseInt(match[3] || match[6]);
      
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // Generate code function - collects layout and sends to backend
    function generateCode() {
      try {
        // Collect current layout data from localStorage (tokens)
        const storageKey = window.LOCAL_STORAGE_KEY || 'dropped_Elements';
        const savedData = localStorage.getItem(storageKey);
        if (!savedData) {
          alert('No elements found in the layout. Please add some elements first.');
          return;
        }

        const layoutTokens = JSON.parse(savedData);
        if (!layoutTokens || layoutTokens.length === 0) {
          alert('No elements found in the layout. Please add some elements first.');
          return;
        }

        // Show loading state
        const generateBtn = document.getElementById('generate');
        const originalText = generateBtn.textContent;
        generateBtn.textContent = 'Generating...';
        generateBtn.disabled = true;

        // Generate comprehensive AST structure
        const ast = generateAST(layoutTokens);
        
        // Convert tokens to the format expected by the backend
        const layoutElements = layoutTokens.map(token => ({
          html: token.html || '',
          id: token.id,
          x: token.x?.toString() || '0',
          y: token.y?.toString() || '0',
          type: token.type?.toLowerCase() || 'div',
          styles: token.styles || {},
          attributes: token.attributes || {},
          width: token.styles?.width || '',
          height: token.styles?.height || '',
          position: token.styles?.position || 'absolute'
        }));

        // Get default preferences (these can be configurable later)
        const preferences = {
          framework: 'react',
          language: 'typescript',
          useTypescript: true,
          useTailwind: false,
          componentLibrary: 'none'
        };

        console.log('üéØ Generated AST:', JSON.stringify(ast, null, 2));
        console.log('üì¶ Layout elements for backend:', layoutElements);

        // Send comprehensive data to VS Code extension
        if (typeof vscode !== 'undefined') {
          vscode.postMessage({
            command: 'generateCode',
            layout: layoutElements,
            ast: ast,
            preferences: preferences,
            metadata: {
              elementCount: layoutTokens.length,
              timestamp: new Date().toISOString(),
              version: '1.0'
            }
          });
          
          console.log('‚úÖ Code generation request sent to VS Code extension');
        } else {
          // Fallback for testing outside VS Code
          console.log('AST:', JSON.stringify(ast, null, 2));
          console.log('Layout elements:', JSON.stringify(layoutElements, null, 2));
          console.log('Preferences:', preferences);
          alert('Code generation triggered! Check the console for AST and layout data.');
        }

        // Reset button state after a delay
        setTimeout(() => {
          generateBtn.textContent = originalText;
          generateBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('‚ùå Error generating code:', error);
        alert('Error generating code. Please try again.');
        
        // Reset button state
        const generateBtn = document.getElementById('generate');
        generateBtn.textContent = 'Generate Code';
        generateBtn.disabled = false;
      }
    }

    // Generate comprehensive AST from layout tokens
    function generateAST(layoutTokens) {
      const ast = {
        type: 'Document',
        children: [],
        metadata: {
          generatedAt: new Date().toISOString(),
          elementCount: layoutTokens.length,
          version: '1.0'
        }
      };

      layoutTokens.forEach((token, index) => {
        const elementNode = {
          type: 'Element',
          id: token.id,
          tagName: token.type?.toLowerCase() || 'div',
          position: {
            x: parseFloat(token.x) || 0,
            y: parseFloat(token.y) || 0,
            zIndex: parseInt(token.styles?.zIndex) || index
          },
          dimensions: {
            width: token.styles?.width || 'auto',
            height: token.styles?.height || 'auto'
          },
          styles: {
            // Layout
            position: token.styles?.position || 'absolute',
            display: token.styles?.display || 'block',
            
            // Appearance
            backgroundColor: token.styles?.backgroundColor || 'transparent',
            color: token.styles?.color || 'inherit',
            opacity: token.styles?.opacity || '1',
            
            // Border
            border: token.styles?.border || 'none',
            borderRadius: token.styles?.borderRadius || '0',
            borderWidth: token.styles?.borderWidth || '0',
            borderColor: token.styles?.borderColor || 'transparent',
            borderStyle: token.styles?.borderStyle || 'solid',
            
            // Spacing
            padding: token.styles?.padding || '0',
            margin: token.styles?.margin || '0',
            
            // Typography
            fontFamily: token.styles?.fontFamily || 'inherit',
            fontSize: token.styles?.fontSize || 'inherit',
            fontWeight: token.styles?.fontWeight || 'normal',
            textAlign: token.styles?.textAlign || 'left',
            lineHeight: token.styles?.lineHeight || 'normal',
            letterSpacing: token.styles?.letterSpacing || 'normal',
            textDecoration: token.styles?.textDecoration || 'none',
            
            // Effects
            boxShadow: token.styles?.boxShadow || 'none',
            textShadow: token.styles?.textShadow || 'none',
            transform: token.styles?.transform || 'none',
            
            // Advanced
            overflow: token.styles?.overflow || 'visible',
            minWidth: token.styles?.minWidth || 'auto',
            minHeight: token.styles?.minHeight || 'auto',
            maxWidth: token.styles?.maxWidth || 'none',
            maxHeight: token.styles?.maxHeight || 'none'
          },
          attributes: {
            id: token.attributes?.id || token.id,
            className: token.attributes?.className || '',
            
            // Content attributes
            href: token.attributes?.href || null,
            src: token.attributes?.src || null,
            alt: token.attributes?.alt || null,
            title: token.attributes?.title || null,
            
            // Form attributes
            type: token.attributes?.type || null,
            name: token.attributes?.name || null,
            value: token.attributes?.value || null,
            placeholder: token.attributes?.placeholder || null,
            required: token.attributes?.required || false,
            disabled: token.attributes?.disabled || false,
            
            // Media attributes
            controls: token.attributes?.controls || false,
            autoplay: token.attributes?.autoplay || false,
            
            // Accessibility
            role: token.attributes?.role || null,
            'aria-label': token.attributes?.['aria-label'] || null,
            'aria-describedby': token.attributes?.['aria-describedby'] || null,
            
            // Other
            target: token.attributes?.target || null,
            tabIndex: token.attributes?.tabIndex || null
          },
          content: {
            text: token.html || '',
            isEmpty: !token.html || token.html.trim() === ''
          },
          children: [], // For nested elements (future enhancement)
          metadata: {
            originalType: token.type,
            hasCustomStyles: Object.keys(token.styles || {}).length > 0,
            hasAttributes: Object.keys(token.attributes || {}).length > 0
          }
        };

        ast.children.push(elementNode);
      });

      return ast;
    }

    // Collect layout data from the current state
    function collectLayoutData() {
      const elements = [];
      const droppedElements = document.querySelectorAll('#resizable-element > .dropped-element');
      
      droppedElements.forEach(el => {
        const elementData = {
          id: el.id,
          type: el.tagName.toLowerCase(),
          x: parseInt(el.getAttribute('data-x')) || 0,
          y: parseInt(el.getAttribute('data-y')) || 0,
          
          // Collect computed styles
          styles: {
            width: el.style.width || getComputedStyle(el).width,
            height: el.style.height || getComputedStyle(el).height,
            backgroundColor: el.style.backgroundColor || getComputedStyle(el).backgroundColor,
            color: el.style.color || getComputedStyle(el).color,
            fontSize: el.style.fontSize || getComputedStyle(el).fontSize,
            fontFamily: el.style.fontFamily || getComputedStyle(el).fontFamily,
            fontWeight: el.style.fontWeight || getComputedStyle(el).fontWeight,
            textAlign: el.style.textAlign || getComputedStyle(el).textAlign,
            padding: el.style.padding || getComputedStyle(el).padding,
            margin: el.style.margin || getComputedStyle(el).margin,
            border: el.style.border || getComputedStyle(el).border,
            borderRadius: el.style.borderRadius || getComputedStyle(el).borderRadius,
            boxShadow: el.style.boxShadow || getComputedStyle(el).boxShadow,
            textDecoration: el.style.textDecoration || getComputedStyle(el).textDecoration,
            position: el.style.position || 'relative',
            display: el.style.display || getComputedStyle(el).display,
            overflow: el.style.overflow || getComputedStyle(el).overflow
          },
          
          // Collect element attributes
          attributes: {
            className: el.className,
            id: el.id,
            href: el.href || null,
            src: el.src || null,
            alt: el.alt || null,
            placeholder: el.placeholder || null,
            value: el.value || null,
            type: el.type || null,
            target: el.target || null,
            controls: el.controls || null,
            autoplay: el.autoplay || null
          },
          
          // Extract content based on element type
          content: extractElementContent(el),
          
          // Collect nested elements
          children: collectNestedElements(el)
        };
        
        elements.push(elementData);
      });
      
      return elements;
    }

    // Extract content from different element types
    function extractElementContent(element) {
      const tagName = element.tagName.toLowerCase();
      
      if (['input', 'textarea'].includes(tagName)) {
        return element.value || element.placeholder || '';
      } else if (tagName === 'img') {
        return element.alt || '';
      } else if (tagName === 'a') {
        return element.textContent || '';
      } else if (['table'].includes(tagName)) {
        // For tables, preserve structure
        return element.innerHTML;
      } else if (['ul', 'ol'].includes(tagName)) {
        // For lists, collect items
        const items = [];
        element.querySelectorAll('li').forEach(li => {
          items.push(li.textContent.trim());
        });
        return items;
      } else {
        // For other elements, get text content
        return element.textContent || '';
      }
    }

    // Collect nested elements recursively
    function collectNestedElements(parentElement) {
      const children = [];
      const childElements = parentElement.querySelectorAll(':scope > .dropped-element');
      
      childElements.forEach(child => {
        const childData = {
          id: child.id,
          type: child.tagName.toLowerCase(),
          x: parseInt(child.getAttribute('data-x')) || 0,
          y: parseInt(child.getAttribute('data-y')) || 0,
          styles: {
            width: child.style.width || getComputedStyle(child).width,
            height: child.style.height || getComputedStyle(child).height,
            backgroundColor: child.style.backgroundColor || getComputedStyle(child).backgroundColor,
            color: child.style.color || getComputedStyle(child).color
          },
          content: extractElementContent(child),
          children: collectNestedElements(child) // Recursive for deeply nested elements
        };
        children.push(childData);
      });
      
      return children;
    }

    // Initialize VS Code API if available
    let vscode;
    if (typeof acquireVsCodeApi !== 'undefined') {
      vscode = acquireVsCodeApi();
    }
</script>
  
</body>
</html>
